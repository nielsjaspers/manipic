<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circle Cutout - Manipic</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <div class="tool-container">
        <a href="../index.html" class="back-btn">‚Üê Back</a>
        <h1 class="lora-unique">Circle Cutout</h1>
        <div class="upload-area" id="uploadArea">
            <svg width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7,10 12,15 17,10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            <p>Click to upload or paste image from clipboard</p>
            <input id="fileInput" type="file" accept="image/*" style="display:none" />
        </div>
        <canvas id="canvas" style="display:none;"></canvas>
        <div class="customization" id="customization">
            <label>Background:</label>
            <div class="segmented" id="bgSegmented" role="tablist">
                <button data-value="white" class="active" role="tab" aria-selected="true">White</button>
                <button data-value="black" role="tab">Black</button>
                <button data-value="transparent" role="tab">Transparent</button>
                <button data-value="custom" role="tab">Custom</button>
            </div>
            <div class="custom-field" id="customField">
                <input type="color" id="customBg">
            </div>
        </div>
        <button id="downloadBtn" style="display:none;">Download</button>
    </div>
    <script src="../script.js"></script>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let img = null;
        let originalFilename = 'image.png';
        let currentBg = 'white';

        bindPersistentFileInput(
            document.getElementById('uploadArea'),
            document.getElementById('fileInput'),
            (file) => loadImage(file)
        );

        handleClipboardPaste((pastedImg) => {
            img = pastedImg;
            originalFilename = 'clipboard.png';
            drawCircle();
        });

        function loadImage(file) {
            originalFilename = file.name;
            const reader = new FileReader();
            reader.onload = (e) => {
                img = new Image();
                img.onload = () => drawCircle();
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function drawCircle() {
            if (!img) return;
            document.getElementById('uploadArea').style.display = 'none';
            document.getElementById('canvas').style.display = 'block';
            document.getElementById('customization').classList.add('show');
            document.getElementById('downloadBtn').style.display = 'block';
            const size = Math.min(img.width, img.height);
            canvas.width = size;
            canvas.height = size;
            if (currentBg === 'transparent') {
                ctx.clearRect(0, 0, size, size);
            } else if (currentBg === 'custom') {
                ctx.fillStyle = document.getElementById('customBg').value;
                ctx.fillRect(0, 0, size, size);
            } else {
                ctx.fillStyle = currentBg;
                ctx.fillRect(0, 0, size, size);
            }
            const centerX = size / 2;
            const centerY = size / 2;
            ctx.save();
            ctx.beginPath();
            ctx.arc(centerX, centerY, size / 2, 0, 2 * Math.PI);
            ctx.clip();
            ctx.drawImage(img, 0, 0, size, size);
            ctx.restore();
        }

        initSegmented(document.getElementById('bgSegmented'));
        document.getElementById('bgSegmented').addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                document.querySelectorAll('#bgSegmented button').forEach(btn => btn.setAttribute('aria-selected', btn === e.target ? 'true' : 'false'));
                currentBg = e.target.dataset.value;
                if (img) drawCircle();
                document.getElementById('customField').classList.toggle('show', currentBg === 'custom');
            }
        });

        document.getElementById('customBg').addEventListener('input', () => {
            if (img && currentBg === 'custom') drawCircle();
        });

        document.getElementById('downloadBtn').addEventListener('click', () => {
            downloadCanvas(canvas, originalFilename, 'circle');
        });
    </script>
</body>
</html>